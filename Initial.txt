##########SUNSHINE SETUP###################
Start-Process -FilePath "$env:USERPROFILE\Downloads\Sunshine-Windows-AMD64-installer.exe"-ArgumentList "/S" -Wait -NoNewWindow

sc.exe create sunshine binPath= "C:\Program Files\Sunshine\sunshine.exe\" start= auto DisplayName= "Sunshine"


Start-Process -FilePath "${env:ProgramFiles}\Sunshine\sunshine.exe" -WorkingDirectory "C:\Program Files\Sunshine"  -Verb RunAs -WindowStyle Hidden

cd 'C:\Program Files\Sunshine\'
.\sunshine.exe --creds bluefml1 letmeinpls
Stop-Process -Name sunshine -Force

Start-Process -FilePath "${env:ProgramFiles}\Sunshine\sunshine.exe" -WorkingDirectory "C:\Program Files\Sunshine"  -Verb RunAs -WindowStyle Hidden



##########Moonlight WEb set up############
Invoke-WebRequest "https://github.com/MrCreativ3001/moonlight-web-stream/releases/download/v1.6/moonlight-web-x86_64-pc-windows-gnu.zip" -OutFile "$env:USERPROFILE\Downloads\moonlight-web-x86_64-pc-windows-gnu.zip" -UseBasicParsing

Expand-Archive -Path "$env:USERPROFILE\Downloads\moonlight-web-x86_64-pc-windows-gnu.zip" -DestinationPath "$env:USERPROFILE\Downloads\moonlight-web" -Force

New-Item -Path "$env:USERPROFILE\Downloads\moonlight-web\server" -ItemType Directory -Force | Out-Null
Invoke-WebRequest "https://raw.githubusercontent.com/bluefml1/bongsenvang-assets/main/config.json" -OutFile "$env:USERPROFILE\Downloads\moonlight-web\server\config.json" -UseBasicParsing

Start-Process -FilePath "$env:USERPROFILE\Downloads\moonlight-web\web-server.exe" -WorkingDirectory "$env:USERPROFILE\Downloads\moonlight-web\"  -WindowStyle Hidden



####################Cloudflare Tunnel##################
curl.exe -L "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-windows-amd64.exe" -o "$env:USERPROFILE\Downloads\cloudflared.exe"


curl.exe "https://api.cloudflare.com/client/v4/accounts/6d54e9aa12b7627c5fb230ae1cb8e377/tokens/verify" -H "Authorization: Bearer __Token__"

$response = InvokeRe-stMethod -Uri "https://api.cloudflare.com/client/v4/accounts/6d54e9aa12b7627c5fb230ae1cb8e377/cfd_tunnel" -Method POST -Headers @{ "Authorization" = "Bearer " } -Body '{ "name": "api-tunnel", "config_src": "cloudflare" }' -ContentType "application/json"
$tunnel_id = $response.result.id
$tunnel_token = $response.result.token

Invoke-RestMethod -Uri "https://api.cloudflare.com/client/v4/accounts/6d54e9aa12b7627c5fb230ae1cb8e377/cfd_tunnel/$tunnel_id/configurations" -Method PUT -Headers @{ "Authorization" = "Bearer cNElIfRgVRUltTf0owZ3TNgF9k_BQdAfYP-PNGaO" } -Body '{ "config": { "ingress": [ { "hostname": "nguyentranviethung.org", "service": "http://127.0.0.1:8080", "originRequest": {} }, { "service": "http_status:404" } ] } }' -ContentType "application/json"

$zone_id = (Invoke-RestMethod -Uri "https://api.cloudflare.com/client/v4/zones?name=nguyentranviethung.org" -Headers @{ "Authorization" = "Bearer " }).result[0].id
 Invoke-RestMethod -Uri "https://api.cloudflare.com/client/v4/zones/$zone_id/dns_records" -Method POST -Headers @{ "Authorization" = "Bearer " } -Body "{`"type`":`"CNAME`",`"proxied`":true,`"name`":`"nguyentranviethung.org`",`"content`":`"$tunnel_id.cfargotunnel.com`"}" -ContentType "application/json"

.\cloudflared.exe service install $tunnel_token
